# version: docker/dockerfile:1.7-labs

services:
  recorder:
    environment:
      - ASPNETCORE_HTTP_PORTS=5123
      # - ASPNETCORE_HTTPS_PORTS=7094
    ports:
      # props/launchsettings
      # iis settings
      # - 22845
      # - 44398
      # swagger https(part1)
      - 7094:7094
      # swagger http
      - 5123:5123
    #privileged: true
    # devices:
    #   - /dev/gpiomem
    # volumes:
    #   - /sys/class/gpio:/sys/class/gpio
    #   - /sys:/sys
    image: gardensage-recorder
    # build:
    #   context: ..
    #   dockerfile: GardenSage.Recorder/Dockerfile
    #FIXME something is wrong with dockercompose --build, image differs from `dotnet publish -p:PublishProfile=DefaultContainer` ()
    # !  Could not load file or assembly 'GardenSage.Recorder ...
  #
  homeassistant:
    container_name: homeassistant
    image: ghcr.io/home-assistant/home-assistant:stable
    volumes:
      # MUST RUN LINUX OR WSL
      - /etc/localtime:/etc/localtime:ro
      - /run/dbus:/run/dbus:ro # optional; req for bluetooth
      # https://sequr.be/blog/2022/11/home-assistant-container-part-11-bluetooth-support/#:~:text=To%20then%20get%20Home%20Assistant%20to%20recognize%20your,Assistant%20container%20by%20running%20docker-compose%20up%20-d%20homeassistant.
      # host: sudo apt install dbus-broker
      # sudo systemctl enable dbus-broker.service
      #  sudo apt install bluez
      # - /wslbind.txt:/wslbindup.txt:ro # (it does bind correctly on wsl, which confirms docker binds linux-style)
      - ./ha:/config # bind the config folder out from the 
      - ./python_scripts:/config/python_scripts:ro
      #
      - ./config/ha_configuration.yaml:/config/configuration.yaml
      - ./config/ha_automations.yaml:/config/automations.yaml
      - ./config/ha_scripts.yaml:/config/scripts.yaml
      - ./config/ha_scenes.yaml:/config/scenes.yaml
    privileged: true
    environment:
      - TZ=America/Los_Angeles
    ports:
      - 8123:8123
    # http://host.docker.internal:8123
